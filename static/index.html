<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PBPS Emote Search</title>

  <!-- Tailwind CDN (no build step) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            bg0: "#070A13",
            neonCyan: "#39FFEA",
            neonPink: "#FF2BD6",
            neonPurple: "#8B5CFF",
          },
          boxShadow: {
            // neon: "0 0 0.5rem rgba(57,255,234,.35), 0 0 2rem rgba(139,92,255,.15)",
            neonStrong: "0 0 0.6rem rgba(255,43,214,.35), 0 0 2.4rem rgba(57,255,234,.18)",
          }
        }
      }
    }
  </script>

  <style>
    .glass {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      backdrop-filter: blur(10px);
    }
    .noise:before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      opacity: .07;
      mix-blend-mode: overlay;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='140' height='140' filter='url(%23n)' opacity='.9'/%3E%3C/svg%3E");
    }
    .ring-neon {
      box-shadow: 0 0 0 1px rgba(57,255,234,.35), 0 0 18px rgba(57,255,234,.12);
    }

      /*Scrollbar styling */
  /* Firefox */
  #results {
    scrollbar-width: thin;
    scrollbar-color: rgba(57,255,234,.25) transparent;
  }

  /* Chromium (Chrome/Edge/Brave) */
  #results::-webkit-scrollbar {
    width: 10px;
  }
  #results::-webkit-scrollbar-track {
    background: transparent;
  }
  #results::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.14);
    border: 2px solid transparent;
    background-clip: padding-box;
    border-radius: 999px;
  }
  #results::-webkit-scrollbar-thumb:hover {
    background: rgba(57,255,234,0.25);
    border: 2px solid transparent;
    background-clip: padding-box;
  }

  </style>
</head>

<body class="min-h-screen bg-bg0 text-slate-100 relative overflow-x-hidden">
  <!-- Background glow -->
  <div class="pointer-events-none absolute -top-32 left-1/2 -translate-x-1/2 h-[520px] w-[900px] rounded-full blur-3xl opacity-30"
       style="background: radial-gradient(circle at 30% 20%, rgba(57,255,234,.55), transparent 55%),
                        radial-gradient(circle at 70% 35%, rgba(255,43,214,.45), transparent 55%),
                        radial-gradient(circle at 50% 70%, rgba(139,92,255,.45), transparent 60%);">
  </div>

  <div class="noise relative">
    <div class="mx-auto max-w-6xl px-4 py-10">
      <!-- Header -->
      <div class="flex flex-col gap-2">
        <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-xl glass shadow-neon flex items-center justify-center ring-neon">
            <span class="text-neonCyan font-bold">PBPS</span>
          </div>
          <div>
            <h1 class="text-2xl sm:text-3xl font-semibold tracking-tight">Marbles on Stream Emote Search</h1>
            <p class="text-sm text-slate-300">
              Type a partial emote name (supports spaces). Click a result to fetch details.
            </p>
          </div>
        </div>

        <!-- Search row -->
        <div class="mt-5 flex flex-col sm:flex-row gap-3">
          <div class="flex-1">
            <label class="sr-only" for="q">Search</label>
            <div class="glass rounded-2xl px-4 py-3 shadow-neon ring-neon">
              <div class="flex items-center gap-3">
                <span class="text-neonCyan/90">⌕</span>
                <input
                  id="q"
                  class="w-full bg-transparent outline-none placeholder:text-slate-400 text-slate-100"
                  placeholder="Search emote (e.g. golden goat / soseri / spooo)…"
                />
              </div>
            </div>
          </div>

          <button
            id="refreshBtn"
            class="glass rounded-2xl px-5 py-3 shadow-neonStrong ring-neon hover:shadow-neon transition active:scale-[0.99]"
            title="Re-fetch the latest emote list"
          >
            <span class="font-medium text-slate-50">Refresh Emote List</span>
          </button>
        </div>
      </div>

      <!-- Main panels -->
      <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-5">
        <!-- Results -->
        <section class="glass rounded-3xl p-5 shadow-neon ring-neon">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold">
              Results <span class="text-slate-300 font-normal" id="meta">(0)</span>
            </h2>
            <span class="text-xs text-slate-400">Click to view details</span>
          </div>

          <div class="mt-4 rounded-2xl border border-white/10 bg-black/20 overflow-hidden">
            <div id="results" class="max-h-[46vh] overflow-auto divide-y divide-white/5">
              <!-- Results injected here -->
            </div>
          </div>

          <!-- Keep this debug section; you had it before -->
          <!-- hr div class="muted">Last /api/emotes response</div -->
          <div class="mt-5 hidden">
            <!-- <div class="text-xs text-slate-400 mb-2">Last /api/emotes response</div> -->
            <pre id="debug"
                 class="rounded-2xl border border-white/10 bg-black/30 p-4 text-xs text-slate-200 overflow-auto max-h-56"></pre>
          </div>
        </section>

        <!-- Details -->
        <section class="glass rounded-3xl p-5 shadow-neon ring-neon">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold">Details</h2>
            <span class="text-xs text-slate-400"></span>
          </div>

          <div id="details" class="mt-4 text-sm text-slate-300">
            Click an emote to load details…
          </div>
        </section>
      </div>

    </div>
  </div>

  <script>
    const q = document.getElementById("q");
    const resultsEl = document.getElementById("results");
    const detailsEl = document.getElementById("details");
    const metaEl = document.getElementById("meta");
    const debugEl = document.getElementById("debug");
    const refreshBtn = document.getElementById("refreshBtn");

    let lastTimer = null;

    function escapeHtml(s) {
      return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
    }

    function renderEmptyState(msg) {
      resultsEl.innerHTML = `
        <div class="p-4 text-sm text-slate-400">
          ${escapeHtml(msg)}
        </div>
      `;
    }

    async function search() {
      const term = q.value.trim();
      let data;

      try {
        const res = await fetch(`/api/emotes?q=${encodeURIComponent(term)}&limit=300`);
        data = await res.json();
      } catch (e) {
        data = { detail: String(e) };
      }

      debugEl.textContent = JSON.stringify(data, null, 2);

      const items = data.items || [];
      metaEl.textContent = `(${items.length})`;

      resultsEl.innerHTML = "";
      if (!items.length) {
        renderEmptyState(term ? "No matching emotes." : "Type something to search.");
        return;
      }

      items.forEach(item => {
        const name = item.name;
        const img = item.imageUrl;

        const row = document.createElement("button");
        row.type = "button";
        row.className =
          "w-full text-left px-4 py-3 hover:bg-white/5 transition " +
          "focus:outline-none focus:bg-white/5 flex items-center gap-3";

        row.innerHTML = `
          <div class="h-10 w-10 rounded-xl bg-black/30 border border-white/10 overflow-hidden flex items-center justify-center">
            ${img
              ? `<img src="${escapeHtml(img)}" alt="${escapeHtml(name)}" class="h-full w-full object-contain" />`
              : `<span class="text-xs text-slate-500">—</span>`
            }
          </div>
          <div class="flex-1">
            <div class="font-medium text-slate-100">${escapeHtml(name)}</div>
            <div class="text-xs text-slate-500">Click for details</div>
          </div>
        `;

        row.onclick = () => loadDetails(name);
        resultsEl.appendChild(row);
      });
    }

    async function loadDetails(name) {
      detailsEl.innerHTML = `
        <div class="rounded-2xl border border-white/10 bg-black/20 p-4 text-slate-300">
          Loading <span class="text-neonCyan font-semibold">${escapeHtml(name)}</span>…
        </div>
      `;

      const res = await fetch(`/api/emotes/${encodeURIComponent(name)}`);
      const d = await res.json();

      if (d.detail) {
        detailsEl.innerHTML = `<pre class="rounded-2xl border border-white/10 bg-black/30 p-4 text-xs overflow-auto">${escapeHtml(JSON.stringify(d, null, 2))}</pre>`;
        return;
      }

      if (d.notFound) {
        detailsEl.innerHTML = `
          <div class="rounded-2xl border border-white/10 bg-black/20 p-4 text-slate-300">
            No details found for <span class="text-neonPink font-semibold">${escapeHtml(d.emoteName)}</span>.
          </div>
        `;
        return;
      }

      const imageBlock = d.imageUrl ? `
        <div class="mb-4 flex items-center gap-4">
          <div class="h-24 w-24 rounded-2xl border border-white/10 bg-black/30 p-2 overflow-hidden flex items-center justify-center">
            <img src="${escapeHtml(d.imageUrl)}" alt="${escapeHtml(d.emoteName)}" class="h-full w-full object-contain" />
          </div>
          <div class="text-xs text-slate-400">
            Thumbnail comes from <a class="text-xs text-neonCyan hover:underline"
               href="https://pixelbypixel.studio/emotes" target="_blank" rel="noreferrer">
               PBPS ↗
            </a> official website.
          </div>
        </div>
      ` : "";

      detailsEl.innerHTML = `
        <div class="rounded-3xl border border-white/10 bg-black/20 p-5">
          ${imageBlock}

          <div class="flex items-start justify-between gap-4">
            <div>
              <div class="text-xs text-slate-400">Emote</div>
              <div class="text-lg font-semibold text-slate-100">${escapeHtml(d.emoteName || "")}</div>
            </div>
            <a class="text-xs text-neonCyan hover:underline"
               href="${escapeHtml(d.detailsUrl)}" target="_blank" rel="noreferrer">
               Open original ↗
            </a>
          </div>

          <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div class="rounded-2xl border border-white/10 bg-black/30 p-3">
              <div class="text-xs text-slate-400">Channel</div>
              <div class="mt-1 text-sm text-slate-100">
                ${
                  d.channelUrl
                    ? `<a class="text-neonCyan hover:underline" href="${escapeHtml(d.channelUrl)}" target="_blank" rel="noreferrer">${escapeHtml(d.channel || d.channelUrl)}</a>`
                    : escapeHtml(d.channel || "—")
                }
              </div>
            </div>

            <div class="rounded-2xl border border-white/10 bg-black/30 p-3">
              <div class="text-xs text-slate-400">Source</div>
              <div class="mt-1 text-sm text-slate-100">${escapeHtml(d.source || "—")}</div>
            </div>

            <div class="rounded-2xl border border-white/10 bg-black/30 p-3">
              <div class="text-xs text-slate-400">Tier/Expires</div>
              <div class="mt-1 text-sm text-slate-100">${escapeHtml(d.tier || "—")}</div>
            </div>

            <div class="rounded-2xl border border-white/10 bg-black/30 p-3 hidden">
              <div class="text-xs text-slate-400">Expires</div>
              <div class="mt-1 text-sm text-slate-100">${escapeHtml(d.expires || "—")}</div>
            </div>
          </div>

          <div class="mt-4 hidden">
            <div class="text-xs text-slate-400 mb-2">Raw JSON</div>
            <pre class="rounded-2xl border border-white/10 bg-black/30 p-4 text-xs overflow-auto max-h-64">${escapeHtml(JSON.stringify(d, null, 2))}</pre>
          </div>
        </div>
      `;
    }

    refreshBtn.onclick = async () => {
      refreshBtn.disabled = true;
      refreshBtn.classList.add("opacity-70");

      try {
        const res = await fetch("/api/refresh", { method: "POST" });
        const data = await res.json();
        debugEl.textContent = JSON.stringify(data, null, 2);
      } finally {
        refreshBtn.disabled = false;
        refreshBtn.classList.remove("opacity-70");
      }

      await search();
    };

    q.addEventListener("input", () => {
      clearTimeout(lastTimer);
      lastTimer = setTimeout(search, 150);
    });

    search();
  </script>
</body>
</html>
